box: php
dev:
  steps:
    - install-packages:
        packages: git openssl
    - script:
        name: install composer
        code: curl -sS https://getcomposer.org/installer | sudo php -- --install-dir=/usr/local/bin --filename=composer
    - script:
        name: install dependencies
        code: composer install --no-interaction
    - internal/watch:
        code: php -S 0.0.0.0:8000
        reload: true
build:
  steps:
    - install-packages:
        packages: git
    - script:
        name: Download MongoDB
        code: curl -O https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-3.2.8.tgz
    - script:
        name: Extract MongoDB
        code: tar -zxvf mongodb-linux-x86_64-3.2.8.tgz
    - script:
        name: Installing MongoDB
        code: mkdir -p mongodb && cp -R -n mongodb-linux-x86_64-3.2.8/ mongodb
    - script:
        name: Finishing MongoDB istallation
        code: export PATH=mongodb/bin:$PATH
    - script:
        name: Start MongoDB
        code: mongod  --port 27017
    - script:
        name: Setup MongoDB
        code: mongo localhost:27017/gishiki tests/SetupTestingMongo.js
    - script:
        name: Install MongoDB extension
        code: pecl install mongodb
    - script:
        name: Install XDebug
        code: |-
            pecl install xdebug
    - script:
        name: prepare build folders
        code: |-
            mkdir build
            mkdir build/logs
    - script:
        name: install phpunit
        code: |-
          curl -L https://phar.phpunit.de/phpunit.phar -o /usr/local/bin/phpunit
          chmod +x /usr/local/bin/phpunit
    - script:
        name: install composer
        code: curl -sS https://getcomposer.org/installer | sudo php -- --install-dir=/usr/local/bin --filename=composer
    - script:
        name: install dependencies
        code: composer install --dev --no-interaction
    - script:
        name: Serve application
        code: php -S localhost:8000 >> /dev/null &
    - script:
        name: PHPUnit integration tests
        code: phpunit --configuration phpunit.xml
#    - script:
#        name: Send to Code Climate
#        code: vendor/bin/test-reporter

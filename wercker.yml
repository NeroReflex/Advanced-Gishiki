box: php
dev:
  steps:
    - install-packages:
        packages: git openssl pkg-config libssl-dev
    - script:
        name: install composer
        code: curl -sS https://getcomposer.org/installer | sudo php -- --install-dir=/usr/local/bin --filename=composer
    - script:
        name: install dependencies
        code: composer install --no-interaction
    - internal/watch:
        code: php -S 0.0.0.0:8000
        reload: true
build:
  steps:
    - install-packages:
        packages: git openssl pkg-config libssl-dev
    - script:
        name: prepare build folders
        code: |-
            mkdir build
            mkdir build/logs
    - script:
        name: Download MongoDB
        code: curl -O https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-3.2.8.tgz
    - script:
        name: Extract MongoDB
        code: tar -zxvf mongodb-linux-x86_64-3.2.8.tgz
    - script:
        name: Installing MongoDB
        code: export PATH=mongodb-linux-x86_64-3.2.8/bin:$PATH
    - script:
        name: Creating the Database directory
        code: mkdir -p /data/db && chmod 0777 -R /data/db
    - script:
        name: Start MongoDB
        code: |-
          touch build/logs/mongodb.log
          mongodb-linux-x86_64-3.2.8/bin/mongod --port 27017 > build/logs/mongodb.log &
#    - script:
#        name: Synchronizing MongoDB
#        code: sleep 30
    - script:
        name: Testing PHP
        code: |-
          touch build/logs/phpinfo.log
          php -i > build/logs/phpinfo.log
#    - script:
#        name: Preparing PECL INI
#        code: |-
#          sudo touch /usr/local/etc/php/config.d/pecl.ini
#          sudo chmod 0777 -R /usr/local/etc/php/config.d
#          pecl config-set php_ini /usr/local/etc/php/config.d/pecl.ini
#          pear config-set php_ini /usr/local/etc/php/config.d/pecl.ini
    - script:
        name: Preparing PECL
        code: |-
          pecl config-set php_ini /usr/local/etc/php/php.ini
          pear config-set php_ini /usr/local/etc/php/php.ini
    - script:
        name: Install MongoDB extension
        code: sudo pecl install mongodb-1.1.8
    - script:
        name: Install XDebug
        code: sudo pecl install xdebug-2.4.0
#    - script:
#        name: Finishing installation
#        code: echo -e '\nzend_extension=/usr/local/lib/php/extensions/no-debug-non-zts-20151012/xdebug.so\nextension=/usr/local/lib/php/extensions/no-debug-non-zts-20151012/mongodb.so' >> /usr/local/etc/php/php.ini
    - script:
        name: install phpunit
        code: |-
          curl -L https://phar.phpunit.de/phpunit.phar -o /usr/local/bin/phpunit
          chmod +x /usr/local/bin/phpunit
    - script:
        name: install composer
        code: curl -sS https://getcomposer.org/installer | sudo php -- --install-dir=/usr/local/bin --filename=composer
    - script:
        name: install dependencies
        code: composer install --dev --no-interaction
    - script:
        name: Serve application
        code: php -S localhost:8000 >> /dev/null &
    - script:
        name: Setup MongoDB
        code: mongodb-linux-x86_64-3.2.8/bin/mongo localhost:27017/gishiki tests/SetupTestingMongo.js
    - script:
        name: PHPUnit integration tests
        code: phpunit --configuration phpunit.xml --coverage-clover build/logs/clover.xml
    - script:
        name: Send to Code Climate
        code: vendor/bin/test-reporter

box: php
build:
  steps:
    - install-packages:
        packages: git openssl pkg-config libssl-dev
    - script:
        name: prepare build folders
        code: |-
            mkdir build
            mkdir build/logs
    - script:
        name: Download MongoDB
        code: curl -O https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-3.2.8.tgz
    - script:
        name: Extract MongoDB
        code: tar -zxf mongodb-linux-x86_64-3.2.8.tgz
    - script:
        name: Installing MongoDB
        code: export PATH=mongodb-linux-x86_64-3.2.8/bin:$PATH
    - script:
        name: Creating the Database directory
        code: |-
          rm -rf /data/db
          mkdir -p /data/db && chmod 0777 -R /data/db
    - script:
        name: Start MongoDB
        code: |-
          touch build/logs/mongodb.log
          mongodb-linux-x86_64-3.2.8/bin/mongod --port 27017 > build/logs/mongodb.log &
    - script:
        name: Testing PHP
        code: php -i
    - script:
        name: Preparing PECL INI
        code: |-
          sudo rm -f /usr/local/etc/php/conf.d/pecl.ini
          sudo touch /usr/local/etc/php/conf.d/pecl.ini
          sudo chmod 0775 -R /usr/local/etc/php/conf.d
          pecl config-set php_ini /usr/local/etc/php/conf.d/pecl.ini
          pear config-set php_ini /usr/local/etc/php/conf.d/pecl.ini
    - script:
        name: Install MongoDB extension
        code: pecl install mongodb-1.1.8
    - script:
        name: Install XDebug
        code: pecl install xdebug-2.4.0
    - script:
        name: Install PHPUnit
        code: |-
          curl -L https://phar.phpunit.de/phpunit.phar -o /usr/local/bin/phpunit
          chmod +x /usr/local/bin/phpunit
    - script:
        name: Install Composer
        code: curl -sS https://getcomposer.org/installer | sudo php -- --install-dir=/usr/local/bin --filename=composer
    - script:
        name: Install Dependencies
        code: composer install --dev --no-interaction
#    - internal/watch:
#        code: php -S 0.0.0.0:8000 > /dev/null &
#        reload: true
    - script:
        name: Setup MongoDB
        code: mongodb-linux-x86_64-3.2.8/bin/mongo localhost:27017/gishiki tests/SetupTestingMongo.js
    - script:
        name: PHPUnit integration tests
        code: phpunit --configuration phpunit.xml --coverage-clover build/logs/clover.xml
    - script:
        name: Send to Code Climate
        code: vendor/bin/test-reporter

box: php
dev:
  steps:
    - install-packages:
        packages: git openssl pkg-config libssl-dev libsslcommon2-dev
    - script:
        name: install composer
        code: curl -sS https://getcomposer.org/installer | sudo php -- --install-dir=/usr/local/bin --filename=composer
    - script:
        name: install dependencies
        code: composer install --no-interaction
    - internal/watch:
        code: php -S 0.0.0.0:8000
        reload: true
build:
  steps:
    - install-packages:
        packages: git
    - script:
        name: Download MongoDB
        code: curl -O https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-3.2.8.tgz
    - script:
        name: Extract MongoDB
        code: tar -zxvf mongodb-linux-x86_64-3.2.8.tgz
    - script:
        name: Installing MongoDB
        code: export PATH=mongodb-linux-x86_64-3.2.8/bin:$PATH
    - script:
        name: Dreating db directory
        code: mkdir -p /data/db && chmod 0777 -R /data/db
    - script:
        name: Start MongoDB
        code: mongodb-linux-x86_64-3.2.8/bin/mongod --port 27017 &
    - script:
        name: Synchronizing MongoDB
        code: sleep 30
    - script:
        name: Setup MongoDB
        code: mongodb-linux-x86_64-3.2.8/bin/mongo localhost:27017/gishiki tests/SetupTestingMongo.js
    - script:
        name: Install MongoDB extension
        code: pecl install mongodb
    - script:
        name: Install XDebug
        code: |-
            pecl install xdebug
    - script:
        name: prepare build folders
        code: |-
            mkdir build
            mkdir build/logs
    - script:
        name: install phpunit
        code: |-
          curl -L https://phar.phpunit.de/phpunit.phar -o /usr/local/bin/phpunit
          chmod +x /usr/local/bin/phpunit
    - script:
        name: install composer
        code: curl -sS https://getcomposer.org/installer | sudo php -- --install-dir=/usr/local/bin --filename=composer
    - script:
        name: install dependencies
        code: composer install --dev --no-interaction
    - script:
        name: Serve application
        code: php -S localhost:8000 >> /dev/null &
    - script:
        name: PHPUnit integration tests
        code: phpunit --configuration phpunit.xml
#    - script:
#        name: Send to Code Climate
#        code: vendor/bin/test-reporter
